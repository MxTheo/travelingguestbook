{% extends "admin/main.html" %}
{% load static %}
{% block title %}
    Nieuw ervaring
    {% if form.instance.pk %}
        bewerken
    {% else %}
        aanmaken
    {% endif %}
{% endblock title %}
{% block stylesheet %}
    <link rel="stylesheet"
          href="{% static 'streetactivity/styles/moment_form.css' %}">
{% endblock stylesheet %}
{% block content %}
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                {% include "admin/messages_feed.html" %}
                {% if show_first_moment_message %}
                    <div class="alert alert-info">
                        <h4 class="alert-heading">
                            <i class="bi bi-flower3"></i>
                            Welkom
                        </h4>
                        <p>Denk terug aan het contact dat je op straat maakte. Kun je een paar momenten voor je halen waarop je zelfvertrouwen anders voelde? Neem rustig de tijd om die momenten van zelfvertrouwen in je gedachten voorbij te laten komen.</p>
                        <p>Als je er klaar voor bent, voeg je het eerste punt toe aan de grafiek. Zo help je niet alleen jezelf, maar ook anderen die met hetzelfde bezig zijn.</p>
                    </div>
                {% endif %}
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="display-5 mb-3">
                        {% if request.session.from_experience %}
                        {% if show_first_moment_message %}
                            Eerste punt
                        {% else %}
                            Punt
                        {% endif %}
                        toevoegen aan grafiek
                        {% else %}
                            {% if form.initial.from_practitioner or object.from_practitioner %}
                                <i class="bi bi-person-raised-hand text-warning"></i> Moment als Beoefenaar
                            {% else %}
                                <i class="bi bi-person-walking text-info"></i> Moment als Voorbijganger
                            {% endif %}
                        {% endif %}
                    </h1>
                    {% if activity %}<p class="lead text-muted">"{{ activity.name }}"</p>{% endif %}
                    <div class="alert alert-light border">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Het is helemaal prima als je het niet precies weet of niet helemaal duidelijk kunt zeggen. Je reden mag best een beetje vaag zijn, dat is helemaal ok√©.
                            <p>Alles wat je deelt helpt ons samen straatcontact een beetje meer te begrijpen.</p>
                        </small>
                    </div>
                </div>
                <!-- Form -->
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <!-- Category Selection - St3p 1 -->
                    {% include "streetactivity/step_category_selection.html" with form=form %}
                    <!-- Reflection - Step 2 -->
                    {% include "streetactivity/step_reflection.html" with form=form %}
                    {% if request.session.from_experience %}
                        <!-- Activity - Step 3 -->
                        {% include "streetactivity/step_activity.html" with form=form %}
                    {% endif %}
                    <!-- Submit buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <a href="{% url "cancel-moment-creation" %}"
                           class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-lg"></i> Annuleer
                        </a>
                        {% if request.session.from_experience and not selected_activity %}
                            <span class="d-inline-block"
                                  data-bs-toggle="tooltip"
                                  data-bs-title="Selecteer eerst een activiteit voordat je een punt toevoegt">
                            {% endif %}
                            <button type="submit"
                                    name="submit_action"
                                    value="save_moment"
                                    class="btn btn-primary btn-lg"
                                    {% if request.session.from_experience and not selected_activity %}disabled{% endif %}>
                                {% if request.session.from_experience %}
                                    <i class="bi bi-plus-lg me-1"></i> Punt toevoegen
                                {% else %}
                                    <i class="bi bi-check-lg me-1"></i> Opslaan
                                {% endif %}
                            </button>
                            {% if request.session.from_experience and not selected_activity %}</span>{% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}
{% block javascript %}
    <script>
        // Character counter for report field
        document.addEventListener('DOMContentLoaded', function() {
            const reportField = document.getElementById('{{ form.report.id_for_label }}');
            const maxLength = 367;
            
            if (reportField) {
                // Add character counter
                const counter = document.createElement('div');
                counter.className = 'form-text text-end';
                reportField.parentNode.appendChild(counter);
                
                function updateCounter() {
                    const remaining = maxLength - reportField.value.length;
                    counter.textContent = `${reportField.value.length}/${maxLength} karakters`;
                    counter.className = `form-text text-end ${remaining < 50 ? 'text-warning' : 'text-muted'}`;
                }
                
                reportField.addEventListener('input', updateCounter);
                updateCounter();
            }
            
            // Enhanced radio card selection
            const radioCards = document.querySelectorAll('.card input[type="radio"]');
            for (const radio of radioCards) {
                radio.addEventListener('change', function() {
                    // Remove border-primary from all cards in this group
                    const allCards = this.closest('.row').querySelectorAll('.card');
                    for (const card of allCards) {
                        card.classList.remove('border-primary');
                        card.classList.add('border-light');
                    }
                    
                    // Add border-primary to selected card
                    const selectedCard = this.closest('.card');
                    selectedCard.classList.add('border-primary');
                    selectedCard.classList.remove('border-light');
                });
            }
        });
    </script>
{% endblock javascript %}
