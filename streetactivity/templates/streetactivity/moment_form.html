{% extends "admin/main.html" %}
{% load static %}
{% block title %}
    Nieuw ervaring
    {% if form.instance.pk %}
        bewerken
    {% else %}
        aanmaken
    {% endif %}
{% endblock title %}
{% block stylesheet %}
    <link rel="stylesheet"
          href="{% static 'streetactivity/styles/moment_form.css' %}">
{% endblock stylesheet %}
{% block content %}
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                {% include "admin/messages_feed.html" %}
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="display-5 mb-3">
                        {% if request.session.from_experience %}
                        {% if not experience %}
                            Eerste punt
                        {% else %}
                            Punt
                        {% endif %}
                        toevoegen aan grafiek
                        {% else %}
                            {% if form.initial.from_practitioner or object.from_practitioner %}
                                <i class="bi bi-person-raised-hand text-warning"></i> Moment als Beoefenaar
                            {% else %}
                                <i class="bi bi-person-walking text-info"></i> Moment als Voorbijganger
                            {% endif %}
                        {% endif %}
                    </h1>
                    {% if not experience %}
                        <div class="alert alert-info mt-4">
                            <h4 class="alert-heading">
                                <i class="bi bi-flower3"></i>
                                Welkom
                            </h4>
                            <p>Denk terug aan het contact dat je op straat maakte. Kun je een paar momenten voor je halen waarop je zelfvertrouwen anders voelde? Neem rustig de tijd om die momenten van zelfvertrouwen in je gedachten voorbij te laten komen.</p>
                            <p>Als je er klaar voor bent, voeg je het eerste punt toe aan de grafiek. Zo help je niet alleen jezelf, maar ook anderen die met hetzelfde bezig zijn.</p>
                        </div>
                    {% else %}
                        <div class="card mb-4 border-primary border-2 rounded">
                            <div class="card-body">
                                <div class="chart-container position-relative">
                                    <canvas id="confidenceChart" height="300px"></canvas>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    {% if activity %}<p class="lead text-muted">"{{ activity.name }}"</p>{% endif %}
                </div>
                <!-- Form -->
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <!-- Category Selection - St3p 1 -->
                    {% include "streetactivity/step_category_selection.html" with form=form %}
                    <!-- Reflection - Step 2 -->
                    {% include "streetactivity/step_reflection.html" with form=form %}
                    {% if request.session.from_experience %}
                        <!-- Activity - Step 3 -->
                        {% include "streetactivity/step_activity.html" with form=form %}
                    {% endif %}
                    <!-- Submit buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                        <a href="{% url "cancel-moment-creation" %}"
                           class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x-lg"></i> Annuleer
                        </a>
                        {% if experience %}
                            <button type="submit"
                                    name="submit_action"
                                    value="save_moment"
                                    class="btn btn-secondary btn-sm">
                                    <i class="bi bi-check-lg me-1"></i> Opslaan
                            </button>
                        {% endif %}
                        </div>
                        {% if not selected_activity %}
                        <span class="d-inline-block"
                                data-bs-toggle="tooltip"
                                data-bs-title="Selecteer eerst een activiteit voordat je de volgende toevoegt">
                        {% endif %}
                        {% if request.session.from_experience %}
                        <button type="submit"
                                    name="submit_action"
                                    value="add_another"
                                    class="btn btn-primary btn-lg" {% if not selected_activity %}disabled{% endif %}>
                                    <i class="bi bi-plus-lg me-1"></i> Volgende toevoegen
                        </button>
                        {% if not selected_activity %}</span>{% endif %}
                        {% endif %}
                        {% if not request.session.from_experience %}
                        <button type="submit"
                                    name="submit_action"
                                    value="save_moment"
                                    class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-lg me-1"></i> Opslaan
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}
{% block javascript %}
    <script>
        // Character counter for report field
        document.addEventListener('DOMContentLoaded', function() {
            const reportField = document.getElementById('{{ form.report.id_for_label }}');
            const maxLength = 367;
            
            if (reportField) {
                // Add character counter
                const counter = document.createElement('div');
                counter.className = 'form-text text-end';
                reportField.parentNode.appendChild(counter);
                
                function updateCounter() {
                    const remaining = maxLength - reportField.value.length;
                    counter.textContent = `${reportField.value.length}/${maxLength} karakters`;
                    counter.className = `form-text text-end ${remaining < 50 ? 'text-warning' : 'text-muted'}`;
                }
                
                reportField.addEventListener('input', updateCounter);
                updateCounter();
            }
            
            // Enhanced radio card selection
            const radioCards = document.querySelectorAll('.card input[type="radio"]');
            for (const radio of radioCards) {
                radio.addEventListener('change', function() {
                    // Remove border-primary from all cards in this group
                    const allCards = this.closest('.row').querySelectorAll('.card');
                    for (const card of allCards) {
                        card.classList.remove('border-primary');
                        card.classList.add('border-light');
                    }
                    
                    // Add border-primary to selected card
                    const selectedCard = this.closest('.card');
                    selectedCard.classList.add('border-primary');
                    selectedCard.classList.remove('border-light');
                });
            }
        });
    </script>
    {% if experience %}
        {% include "streetactivity/one_experience_chart_js.html" with moments_json=moments_json %}
    {% endif %}
{% endblock javascript %}
