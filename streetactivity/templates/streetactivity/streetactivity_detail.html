{% extends "admin/main.html" %}
{% load static %}
{% block title %}
    {{ activity.name }} - Straatactiviteit
{% endblock title %}
{% block stylesheet %}
    <link href="{% static "streetactivity/styles/streetactivity_detail.css" %}" rel="stylesheet">
{% endblock stylesheet %}
{% block content %}
    <div class="container py-4">
        <!-- Header sectie met titel en basisinfo -->
        <header class="mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h1 class="text-success-emphasis">{{ activity.name }}</h1>
                </div>
                <div>
                    <a href="{% url 'delete-streetactivity' activity.pk %}"
                       class="btn btn-outline-danger me-2">
                        <i class="bi bi-trash"></i> Verwijder
                    </a>
                    <a href="{% url 'update-streetactivity' activity.pk %}"
                       class="btn btn-outline-primary">
                        <i class="bi bi-pencil-square"></i> Bewerk
                    </a>
                </div>
            </div>
        </header>
        <!-- Kernvraag sectie -->
        <section class="mb-4 p-3 bg-light rounded">
            <h2 class="h4 mb-3">Uitnodiging</h2>
            <blockquote class="core-question fs-5 text-success-emphasis mb-0">
                "{{ activity.question }}"
            </blockquote>
        </section>
        <!-- Beschrijving sectie -->
        <section class="mb-4">
            <h2 class="h4 text-primary mb-3">Stap-voor-stap handleiding</h2>
            <div class="description-content fs-6 lh-base">{{ activity.description|linebreaks }}</div>
        </section>
        <!-- Praktische informatie -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <section class="card h-100">
                    <div class="card-body">
                        <h3 class="h5 card-title text-primary">
                            <i class="bi bi-tools"></i> Benodigdheden
                        </h3>
                        <div class="supplies-content">{{ activity.supplies|linebreaks }}</div>
                    </div>
                </section>
            </div>
        </div>
        <!-- ERVARINGSDASHBOARD SECTIE -->
        <section class="experience-dashboard mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="h4 mb-4">Collectief Ervaringsbegrip</h2>
                    <p class="text-muted mb-4">
                        <i class="bi bi-info-circle"></i>
                        Elk momentopname draagt bij aan het gedeelde begrip van deze straatactiviteit. Iedereen kan bijdragen om de straatactiviteit verder te ontwikkelen.
                    </p>
                </div>
            </div>
            <!-- Actie Knoppen - Nieuwe Ervaringen -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <span class="me-2">Ervaringen filteren:</span>
                            <div class="btn-group" role="group">
                                <input type="radio"
                                       class="btn-check"
                                       name="experienceFilter"
                                       id="filterEveryone"
                                       autocomplete="off"
                                       checked>
                                <label class="btn btn-outline-primary" for="filterEveryone">
                                    <i class="bi bi-people fs-6"></i> Iedereen
                                </label>
                                <input type="radio"
                                       class="btn-check"
                                       name="experienceFilter"
                                       id="filterPractitioners"
                                       autocomplete="off">
                                <label class="btn btn-outline-primary" for="filterPractitioners">
                                    <i class="bi bi-person-raised-hand fs-6"></i> Alleen Beoefenaars
                                </label>
                                <input type="radio"
                                       class="btn-check"
                                       name="experienceFilter"
                                       id="filterPassersby"
                                       autocomplete="off">
                                <label class="btn btn-outline-primary" for="filterPassersby">
                                    <i class="bi bi-person-walking fs-6"></i> Alleen Voorbijgangers
                                </label>
                            </div>
                            <small class="text-muted ms-2" id="filterCount">Totaal: {{ experiences_count }} ervaringen</small>
                        </div>
                        <!-- Knoppen voor nieuwe ervaringen -->
                        <div class="d-flex gap-2">
                            <a href="{% url 'create-experience-from-practitioner' activity.pk %}"
                               class="btn btn-success btn-sm">
                                <i class="bi bi-person-raised-hand fs-6"></i> Ervaring als Beoefenaar
                            </a>
                            <a href="{% url 'create-experience-from-passerby' activity.pk %}"
                               class="btn btn-info btn-sm">
                                <i class="bi bi-person-walking fs-6"></i> Ervaring als Voorbijganger
                            </a>
                            <a href="{% url 'experience-list-streetactivity' activity.pk %}"
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-list-ul"></i> Alle Ervaringen
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cumulatieve Ervaringsstroom en Levende Tags -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-pie-chart"></i> Gevoel van zelfverzekerdheid
                            </h5>
                            <!-- Donut Chart Container -->
                            <div class="text-center">
                                <div class="donut-chart mx-auto mb-3">
                                    <canvas id="experienceChart"></canvas>
                                </div>
                                <!-- Legend -->
                                <div class="row g-2 justify-content-center">
                                    <div class="col-auto">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary me-2">&nbsp;</span>
                                            <small>Onzeker</small>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-warning me-2">&nbsp;</span>
                                            <small>Tussenin</small>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-success me-2">&nbsp;</span>
                                            <small>Zelfverzekerd</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p class="small text-muted mb-1">
                                    <strong id="totalExperiences">{{ experiences_count }}</strong> ervaringen gedeeld
                                </p>
                                <p class="small text-muted">"De verdeling van alle gedeelde momentopnames"</p>
                                <div>
                                    <a href="{% url 'experience-list-streetactivity' activity.pk %}"
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-list-ul"></i> Bekijk alle ervaringen
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Levende Tags -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-tags"></i> Waarom het zo is ervaren
                            </h5>
                            <!-- Word Cloud Container -->
                            <div class="word-cloud" id="wordCloud">
                                {% for tag in all_tags %}
                                    <span class="word-cloud-tag"
                                          data-tag-id="{{ tag.id }}"
                                          data-count="{{ tag.count }}"
                                          data-category="{{ tag.nvc_category }}">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <p class="small text-muted">"Indruk van alle momenten"</p>
                            </div>
                            <div class="mt-3">
                                <a href="{% url 'tag-list' %}" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-tags"></i>
                                    Overzicht beschikbare tags
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- EINDE ERVARINGSDASHBOARD SECTIE -->
        <!-- Navigatie knoppen -->
        <div class="action-buttons pt-3 border-top">
            <a href="{% url 'streetactivity-list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Terug naar overzicht
            </a>
        </div>
    </div>
{% endblock content %}
{% block javascript %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('experienceChart').getContext('2d');
    let experienceChart;
    
    // Gebruik Bootstrap CSS variabelen voor kleuren
    const styles = getComputedStyle(document.documentElement);
    const primaryColor = styles.getPropertyValue('--bs-primary') || '#0d6efd';
    const warningColor = styles.getPropertyValue('--bs-warning') || '#ffc107';
    const successColor = styles.getPropertyValue('--bs-success') || '#198754';
    const secondaryColor = styles.getPropertyValue('--bs-secondary') || '#6c757d';
    
    // Data voor verschillende filters
    const chartData = {
        everyone: {{ chart_data_everyone|safe }},
        practitioners: {{ chart_data_practitioners|safe }},
        passersby: {{ chart_data_passersby|safe }}
    };
    
    const tagData = {
        everyone: {{ tag_data_everyone|safe }},
        practitioners: {{ tag_data_practitioners|safe }},
        passersby: {{ tag_data_passersby|safe }}
    };
    
    const countData = {
        everyone: {{ experiences_count }},
        practitioners: {{ practitioner_count }},
        passersby: {{ passerby_count }}
    };
    
    // Initialiseer chart
    function initChart(data) {
        if (experienceChart) {
            experienceChart.destroy();
        }
        
        experienceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['onzeker', 'tussenin', 'zelfverzekerd'],
                datasets: [{
                    data: [data.pioneer, data.intermediate, data.climax],
                    backgroundColor: [
                        primaryColor,
                        warningColor, 
                        successColor
                    ],
                    borderWidth: 2,
                    borderColor: styles.getPropertyValue('--bs-body-bg') || '#fff'
                }]
            },
            options: {
                cutout: '60%',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Update woordwolk
    function updateWordCloud(tags) {
        const wordCloud = document.getElementById('wordCloud');
        wordCloud.innerHTML = '';
        
        tags.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'word-cloud-tag';
            span.textContent = tag.name;
            span.setAttribute('data-tag-id', tag.id);
            span.setAttribute('data-count', tag.count);
            span.setAttribute('data-category', tag.nvc_category);
            
            // Dynamische grootte gebaseerd op count
            const baseSize = 14;
            const size = baseSize + (tag.count * 2);
            span.style.fontSize = `${Math.min(size, 24)}px`;
            span.style.opacity = 0.7 + (tag.count * 0.1);
            
            wordCloud.appendChild(span);
        });
    }
    
    // Filter handlers
    document.querySelectorAll('input[name="experienceFilter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const filterType = this.id.replace('filter', '').toLowerCase();
            
            // Update chart
            initChart(chartData[filterType]);
            
            // Update word cloud
            updateWordCloud(tagData[filterType]);
            
            // Update count
            document.getElementById('filterCount').textContent = `Totaal: ${countData[filterType]} ervaringen`;
            document.getElementById('totalExperiences').textContent = countData[filterType];
        });
    });
    
    // Laad initiÃ«le data
    initChart(chartData.everyone);
    updateWordCloud(tagData.everyone);
});
    </script>
{% endblock javascript %}
